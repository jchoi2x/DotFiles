#include <msp430fg4618.h>
#include "LCD_Ctrl.h"

// 0 1 2 3 4 5 6 7 8 9 A B C D E F
extern unsigned int characters[] = { 0x5f, 0x06, 0x6b, 0x2f, 0x36, 0x3d, 0x7d, 0x07, 0x7f, 0x37, 0x77, 0x7c, 0x59, 0x6E, 0x79, 0x71 };
extern unsigned char *LCDSeg = (unsigned char *) &LCDM3;

//---------------------------------------------------------------------
// Initialize the LCD system
//---------------------------------------------------------------------
void init_LCD(void) {
    unsigned char *LCDSeg = (unsigned char *) &LCDM3;
    /* Using the LCD A controller for the MSP430fg4618
     * the pins of the LCD are memory mapped onto the mp430F4xxx
     * memory bus and are accessed via LCDSeg[i] array */

    /* <See page 260 of Davie's text>
     * LCD_SIZE-4 only gives the 7 segment displays plus DP, and
     * (colons are the same bit setting)*/

    /* LCD_SIZE-4 only gives the 7 segment displays plus DP, and
     * colons (colons / dp)
     * Right most seven segment display is at LCDSeg[0]; */

    // Clear LCD segment memory
    int n = 0;
    for (n = 0; n < LCD_SIZE; n++) {
        /* initialize the segment memory to zero to clear the LCD
         * writing a zero in the LCD memory location clears turns
         * off the LCD segment
         * Including all of the special characters*/
        *(LCDSeg + n) = 0; // or LCDSeg[n]=0;
    }

    /* - Port 5 ports 5.2-5.4 are connected to com1, com2, com3 of LCD and
     * com0 is fixed and already assigned
     * - Need to assign com1 - com3 to port5 */
    P5SEL = 0x1C; // BIT4 | BIT3 |BIT2 = 1 P5.4, P.3, P5.2 = 1

    /* - Used the internal voltage for the LCD bit 4 = 0 (VLCDEXT=0)
     * - Internal bias voltage set to 1/3 of Vcc, charge pump disabled,
     * (page 26-25 of MSP430x4xx user manual) */

    LCDAVCTL0 = 0x00;
    /* LCDS28-LCDS0 pins LCDS0 = lsb and LCDS28 = MSB need LCDS4 through LCDS24
     * from the experimenter board schematic the LCD uses S4-S24, S0-S3 are not used here.
     * Only use up to S24 on the LCD 28-31 not needed.
     * Also LCDACTL1 not required since not using S32 - S39 ( Davie's book page 260 )
     * page 26-23 of MSP430x4xx user manual */
    LCDAPCTL0 = 0x7E;

    /* - The LCD uses the ACLK as the master clock as the scan rate for
     * the display segments
     * - The ACLK has been set to 32768 Hz with the external 327768 Hz crystal
     * - Let's use scan frequency of 256 Hz (This is fast enough not to see the display flicker)
     * or a divisor of 128
     * - LCDFREQ division(3 bits), LCDMUX (2 bits), LCDSON segments on, Not used, LCDON LCD module on
     * - 011 = freq /128, 11 = 4 mux's needed since the display uses for
     * common inputs com0-com3, need to turn the LCD on LCDON = 1
     * - LCDSON allows the segments to be blanked good for blinking but
     * needs to be on to display the LCD segments LCDSON = 1
     * - Bit pattern required = 0111 1101 = 0x7d (page 26-22 of MSP430x4xx user manual) */
    LCDACTL = 0x7d;
}
